<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Louvre: Chapter 16: Gamma Correction</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="Logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Louvre<span id="projectnumber">&#160;v2.18.1-1</span>
   </div>
   <div id="projectbrief">C++ library for Wayland compositors</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Chapter 16: Gamma Correction</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Since version 1.2.0, <a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a> now offers support for applying custom gamma correction curves to outputs. This feature proves valuable, especially for graphic designers seeking precise representation and translation of their works across various devices, or for implementing functionalities such as adjusting screen temperature based on the current time.</p>
<p>To configure gamma correction curves for an output, you can use <a class="el" href="class_louvre_1_1_l_output.html#a245e2751c991363d19e29fc3e22e1989" title="Sets the gamma correction table for the output.">Louvre::LOutput::setGamma()</a>, which accepts an <a class="el" href="class_louvre_1_1_l_gamma_table.html" title="Gamma correction table for outputs.">Louvre::LGammaTable</a> as an argument. The <a class="el" href="class_louvre_1_1_l_gamma_table.html" title="Gamma correction table for outputs.">Louvre::LGammaTable</a> comprises an array of <a class="el" href="namespace_louvre.html#a8c7e64bfcbd67be1699ac1e4d2a8d6cd" title="16 bits unsigned integer">Louvre::UInt16</a> values representing the components of each curve (red, green, and blue). When creating a table, its size must match the gamma size of the output to which it will be applied, obtainable through <a class="el" href="class_louvre_1_1_l_output.html#a16a1856622b2e0e1d4f3f81961de6e0c" title="Gets the size of the gamma table.">Louvre::LOutput::gammaSize()</a>. Keep in mind that if an output doesn't support gamma correction, it returns 0. It also returns 0 if the output is uninitialized, so it's advisable to set a gamma table only after the output is initialized.</p>
<blockquote class="doxtable">
<p>&zwj;By default, <a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a> assigns linear gamma curves each time an output is initialized. </p>
</blockquote>
<p>Let's have some fun and experiment creating a custom gamma table that inverts the colors displayed on the screen.</p>
<h3><a class="anchor" id="srceoutputcpp-13"></a>
src/EOutput.cpp</h3>
<div class="fragment"><div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;LGammaTable.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> EOutput::initializeGL()</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> UInt32 gSize { gammaSize() };</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (gSize &gt; 0)</div>
<div class="line">    {</div>
<div class="line">        LGammaTable gamma { gSize };</div>
<div class="line"> </div>
<div class="line">        <a class="code hl_typedef" href="namespace_louvre.html#a8c7e64bfcbd67be1699ac1e4d2a8d6cd">UInt16</a> *r { gamma.red()   };</div>
<div class="line">        <a class="code hl_typedef" href="namespace_louvre.html#a8c7e64bfcbd67be1699ac1e4d2a8d6cd">UInt16</a> *g { gamma.green() };</div>
<div class="line">        <a class="code hl_typedef" href="namespace_louvre.html#a8c7e64bfcbd67be1699ac1e4d2a8d6cd">UInt16</a> *b { gamma.blue()  };</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <a class="code hl_typedef" href="namespace_louvre.html#a3f1431cb9f76da10f59246d1d743dc2c">Float64</a> n { (<a class="code hl_typedef" href="namespace_louvre.html#a3f1431cb9f76da10f59246d1d743dc2c">Float64</a>)gSize - 1 };</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (UInt32 i = 0; i &lt; gSize; i++)</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">const</span> <a class="code hl_typedef" href="namespace_louvre.html#a3f1431cb9f76da10f59246d1d743dc2c">Float64</a> val = 1.0 - i/n;</div>
<div class="line">            r[i] = g[i] = b[i] = (<a class="code hl_typedef" href="namespace_louvre.html#a8c7e64bfcbd67be1699ac1e4d2a8d6cd">UInt16</a>)(UINT16_MAX * val);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        setGamma(&amp;gamma);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        LLog::debug(<span class="stringliteral">&quot;[louvre-example] Output %s doesn&#39;t support gamma correction.&quot;</span>, name());</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
<div class="ttc" id="anamespace_louvre_html_a3f1431cb9f76da10f59246d1d743dc2c"><div class="ttname"><a href="namespace_louvre.html#a3f1431cb9f76da10f59246d1d743dc2c">Louvre::Float64</a></div><div class="ttdeci">double Float64</div><div class="ttdoc">64 bits float</div><div class="ttdef"><b>Definition</b> LNamespaces.h:243</div></div>
<div class="ttc" id="anamespace_louvre_html_a8c7e64bfcbd67be1699ac1e4d2a8d6cd"><div class="ttname"><a href="namespace_louvre.html#a8c7e64bfcbd67be1699ac1e4d2a8d6cd">Louvre::UInt16</a></div><div class="ttdeci">uint16_t UInt16</div><div class="ttdoc">16 bits unsigned integer</div><div class="ttdef"><b>Definition</b> LNamespaces.h:225</div></div>
</div><!-- fragment --><p>Upon recompiling and running, you should observe something like this on outputs that support gamma correction:</p>
<p><img src="https://lh3.googleusercontent.com/pw/ABLVV84-HXAmJ5CXMpVFMdbIUlpc70MeQD3HTFYvDW3piVYv28u6rmdW2GcetZMFnoxtZ9E8aMEnWswl7eouc4HZXcHUUPUnjoZnwgGjF9i_m-HXMiIS4qk=w2400" alt="" class="inline"/></p>
<p>Now, this is, of course, just a demonstration of how to manually configure each RGB curve. The <a class="el" href="class_louvre_1_1_l_gamma_table.html" title="Gamma correction table for outputs.">Louvre::LGammaTable</a> also provides an auxiliary method (<a class="el" href="class_louvre_1_1_l_gamma_table.html#a9502f2ce36c1f8fa1cf9d82397de4aa4" title="Fill method for setting table values.">Louvre::LGammaTable::fill()</a>) that can set the table values for you, accepting parameters such as gamma, contrast, and brightness.</p>
<h2><a class="anchor" id="wlr-gamma-control"></a>
Wlr Gamma Control</h2>
<p>Certain Wayland clients like <a href="http://jonls.dk/redshift/">Redshift</a> or <a href="https://gitlab.com/chinstrap/gammastep">GammaStep</a> can request to set the gamma table through the <a href="https://wayland.app/protocols/wlr-gamma-control-unstable-v1">Wlr Gamma Control</a> protocol. These clients are commonly employed to automatically adjust the "temperature" of screens, applying a cooler tone during the day and a warmer tone during the night.</p>
<p>For security reasons, this feature is disabled by default. You should only permit well-known clients to modify the gamma tables, and the mechanism to identify them is left to your discretion. Let's be a bit trusting for now and allow any client to assign the gamma tables. To do this, first, remove the code we just added and override the <a class="el" href="class_louvre_1_1_l_output.html#a386f3d06f6c9f2d60e66c6da5bf3dd1a" title="Set gamma table request.">Louvre::LOutput::setGammaRequest()</a> virtual method.</p>
<h3><a class="anchor" id="srceoutputh-4"></a>
src/EOutput.h</h3>
<div class="fragment"><div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>EOutput : <span class="keyword">public</span> LOutput</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> setGammaRequest(LClient *client, <span class="keyword">const</span> LGammaTable *gamma) <span class="keyword">override</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
</div><!-- fragment --><h3><a class="anchor" id="srceoutputcpp-14"></a>
src/EOutput.cpp</h3>
<div class="fragment"><div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> EOutput::setGammaRequest(LClient *client, <span class="keyword">const</span> LGammaTable *gamma)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Note: This is quite unsafe, you should only permit well-known</span></div>
<div class="line"><span class="comment">     * clients to set gamma correction curves. */</span></div>
<div class="line">    L_UNUSED(client)</div>
<div class="line">    </div>
<div class="line">    setGamma(gamma);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
</div><!-- fragment --><p>This method is invoked each time a client requests to set the gamma table for this particular output. If the gamma parameter is set to <code>nullptr</code>, it indicates that the client no longer wishes to control gamma or has been disconnected. It's important to note that passing <code>nullptr</code> to <a class="el" href="class_louvre_1_1_l_output.html#a245e2751c991363d19e29fc3e22e1989" title="Sets the gamma correction table for the output.">Louvre::LOutput::setGamma()</a> restores the default linear gamma curves.</p>
<p>Now, explore launching applications such as Redshift or GammaStep to observe their effects. Pretty neat, isn't it?</p>
<p>In the next chapter, we will delve into the intricacies of fractional scaling and discuss techniques to achieve optimal results and performance while using it. Chao chao!</p>
<p><a href="15.md">◀ Chapter 15: Output Hotplugging and Seat</a> || <a href="17.md">Chapter 17: Fractional Scaling ▶</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<script>
    var menu = false;
    var burger, nav;
    function resp()
    {
        if (window.innerWidth < 768)
        {
            burger.hidden = false;
            nav.hidden = true;
        }
        else
        {
            burger.hidden = true;
            nav.hidden = false;
        }
        menu = false;
    }
    function toggleMenu()
    {
        nav.hidden = menu;
        menu = !menu;
    }
    window.onload = function()
    {
        if (typeof toggleLevel !== "undefined")
            toggleLevel(2);
        // Get all <a> tags with the "el" class
        var elLinks = document.querySelectorAll('a.el');
        // Loop through the matched elements
        elLinks.forEach(function(link) 
        {
            // Replace "Louvre::" with an empty string in the text content
            link.textContent = link.textContent.replace(/Louvre::/g, '');
        });
        nav = document.getElementById('main-nav');
        burger = document.createElement('div');
        burger.style.position = 'absolute';
        burger.style.top = '14px';
        burger.style.right = burger.style.top;
        burger.innerHTML = '<svg onclick="toggleMenu()" height="32px" viewBox="0 0 448 512"><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg>';
        document.getElementById('top').appendChild(burger);
        resp();
    };
    window.onresize = function()
    {
        resp();
    };
</script>
<div id="nav-path" class="navpath">
    <ul>
        <li class="footer">Project developed by <a href="https://github.com/CuarzoSoftware"><img class="footer" src="https://avatars.githubusercontent.com/u/29326763?s=200&v=4" style="margin-left:2px;position:relative;top:-1px;width:12px;height:12px" alt="cuarzo"/> Cuarzo Software</a></li>
    </ul>
</div>