<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Louvre: Chapter 12: Animations</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="Logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Louvre<span id="projectnumber">&#160;v2.18.1-1</span>
   </div>
   <div id="projectbrief">C++ library for Wayland compositors</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Chapter 12: Animations</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In this chapter, we will provide a concise overview of the <a class="el" href="class_louvre_1_1_l_animation.html" title="Time-based animations.">Louvre::LAnimation</a> class, designed for creating time-based animations. <a class="el" href="class_louvre_1_1_l_animation.html" title="Time-based animations.">Louvre::LAnimation</a> consists of two essential callback functions:</p>
<ul>
<li><b>OnUpdate</b>: This callback function is triggered just before an <a class="el" href="class_louvre_1_1_l_output.html#a0569e991ee4c6e4242578aca6d999741" title="Paint Event.">Louvre::LOutput::paintGL()</a> event of any output.</li>
<li><b>OnFinish</b>: This callback function is triggered when the animation reaches its conclusion or when <a class="el" href="class_louvre_1_1_l_animation.html#a8c528baf37154d347366083f0f816846" title="Halts the animation before its duration is reached.">Louvre::LAnimation::stop()</a> is called.</li>
</ul>
<p>To create an animation, you can choose between two options:</p><ul>
<li><b><a class="el" href="class_louvre_1_1_l_animation.html#a62aae1f26499cc65c296f8117fde118a" title="Creates and launches a one-time animation with automatic cleanup.">Louvre::LAnimation::oneShot()</a></b>: This is for creating animations which automatically start and clean up upon completion.</li>
<li><b><a class="el" href="class_louvre_1_1_l_animation.html#a5d4b3219022c3d44c1678ef2bd0ccf58" title="Creates a reusable animation.">Louvre::LAnimation::LAnimation()</a></b>: This is used for creating reusable animations, which must be started manually with <a class="el" href="class_louvre_1_1_l_animation.html#af49c603a002db3c46b470d2fcfd96046" title="Starts the animation.">Louvre::LAnimation::start()</a>.</li>
</ul>
<p>In this example, we will employ <a class="el" href="class_louvre_1_1_l_animation.html#a62aae1f26499cc65c296f8117fde118a" title="Creates and launches a one-time animation with automatic cleanup.">Louvre::LAnimation::oneShot()</a> to implement a fade-out animation for toplevels or popups when they are destroyed.</p>
<p>Let's override the virtual destructors of <a class="el" href="class_louvre_1_1_l_toplevel_role.html" title="Toplevel role for surfaces.">Louvre::LToplevelRole</a> and <a class="el" href="class_louvre_1_1_l_popup_role.html" title="Popup role for surfaces.">Louvre::LPopupRole</a> and also create a new method called <code>fadeOutSurface()</code> within <a class="el" href="class_louvre_1_1_l_compositor.html" title="Louvre&#39;s core and objects factory.">Louvre::LCompositor</a> for generating this animation.</p>
<h3><a class="anchor" id="srcecompositorh-7"></a>
src/ECompositor.h</h3>
<div class="fragment"><div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ESurface;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ECompositor : <span class="keyword">public</span> LCompositor</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Virtual destructors</span></div>
<div class="line">    <span class="keywordtype">void</span> destroyToplevelRoleRequest(LToplevelRole *toplevel) <span class="keyword">override</span>;</div>
<div class="line">    <span class="keywordtype">void</span> destroyPopupRoleRequest(LPopupRole *popup) <span class="keyword">override</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Fade out surface animation</span></div>
<div class="line">    <span class="keywordtype">void</span> fadeOutSurface(ESurface *surface, UInt32 ms);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">};</div>
</div><!-- fragment --><p>Using these virtual destructors is a more secure approach compared to relying on the destructors of the classes themselves. This is due to the fact that virtual destructors are invoked well in advance of the class being fully destroyed. Consequently, many of its parameters and resources remain valid at that point.</p>
<h3><a class="anchor" id="srcecompositorcpp-8"></a>
src/ECompositor.cpp</h3>
<div class="fragment"><div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;LAnimation.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ECompositor::destroyToplevelRoleRequest(LToplevelRole *toplevel)</div>
<div class="line">{</div>
<div class="line">    fadeOutSurface((ESurface*)toplevel-&gt;surface(), 400);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ECompositor::destroyPopupRoleRequest(LPopupRole *popup)</div>
<div class="line">{</div>
<div class="line">    fadeOutSurface((ESurface*)popup-&gt;surface(), 50);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ECompositor::fadeOutSurface(ESurface *surface, UInt32 ms)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!surface)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    LTexture *capture = surface-&gt;capture(surface-&gt;size() * 2);</div>
<div class="line">    LTextureView *fadeOutView = <span class="keyword">new</span> LTextureView(capture, &amp;cursorLayer);</div>
<div class="line">    fadeOutView-&gt;setBufferScale(2);</div>
<div class="line">    fadeOutView-&gt;enableParentOffset(<span class="keyword">false</span>);</div>
<div class="line">    fadeOutView-&gt;setPos(surface-&gt;rolePos());</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Stack it below the software cursor view</span></div>
<div class="line">    fadeOutView-&gt;insertAfter(<span class="keyword">nullptr</span>);</div>
<div class="line"> </div>
<div class="line">    LAnimation::oneShot(ms,</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// On Update</span></div>
<div class="line">    [<span class="keyword">this</span>, fadeOutView](LAnimation *anim)</div>
<div class="line">    {</div>
<div class="line">        fadeOutView-&gt;setOpacity(1.f - anim-&gt;value());</div>
<div class="line">        repaintAllOutputs();</div>
<div class="line">    },</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// On Finish</span></div>
<div class="line">    [<span class="keyword">this</span>, fadeOutView](LAnimation *)</div>
<div class="line">    {</div>
<div class="line">        repaintAllOutputs();</div>
<div class="line">        <span class="keyword">delete</span> fadeOutView-&gt;texture();</div>
<div class="line">        <span class="keyword">delete</span> fadeOutView;</div>
<div class="line">    });</div>
<div class="line">}</div>
</div><!-- fragment --><p>Now, once a toplevel or popup is being destroyed, we call the <code>fadeOutSurface()</code> method. This method takes two parameters: the surface to animate and the duration of the animation in milliseconds.</p>
<p>Within this method, we take several steps:</p>
<ol type="1">
<li>We first check if the surface is <code>nullptr</code>. This check is essential because in some uncommon cases, the role may be destroyed when it's not yet attached to a surface. It's crucial always to verify this.</li>
<li>Next, we create a screenshot of the surface using the <code>ESurface::capture()</code> method we introduced earlier. Then, we generate a texture view to display the captured texture and insert it into the cursor layer. This ensures that it remains visible above other views, even if there is a toplevel in fullscreen mode.</li>
<li>Within the <code>onUpdate()</code> callback, we simply manipulate the view's opacity from 1.0 to 0.0 using the <a class="el" href="class_louvre_1_1_l_animation.html#affc50f5fe77662cac4b1f5a31d32c639" title="Returns a number linearly interpolated from 0.0 to 1.0.">Louvre::LAnimation::value()</a> property. This property returns a floating-point number ranging from 0.0 to 1.0, indicating the completion percentage of the animation.</li>
<li>It's important to note that we also need to call <a class="el" href="class_louvre_1_1_l_output.html#a3640e75ecf0af51755b05a1e1262b25c" title="Unlocks the rendering thread.">Louvre::LOutput::repaint()</a> on the outputs we are animating. Otherwise, the next <code>onUpdate()</code> callback may not be triggered.</li>
<li>Finally, within the <code>onFinish()</code> callback, we destroy the captured texture and the texture view. Since we are using <a class="el" href="class_louvre_1_1_l_animation.html#a62aae1f26499cc65c296f8117fde118a" title="Creates and launches a one-time animation with automatic cleanup.">Louvre::LAnimation::oneShot()</a>, the animation is automatically destroyed upon completion.</li>
</ol>
<p>If you recompile and run the compositor, you will notice that toplevels and popups now smoothly fade out when they are destroyed.</p>
<p><img src="https://lh3.googleusercontent.com/pw/ADCreHdFDc8mTY0fxNtr42T-7ACP0wdINLsLKahQ_wQu8M4O112dJBOi5qUvb_sPADRAcN46uCBNASlF2j1tvYsO3fIZma0O8JtULThP9LoJ5VXqBxYDGLo=w2400" alt="" class="inline"/></p>
<p>In the upcoming chapter, we will delve into how to manage cursors using the <a class="el" href="class_louvre_1_1_l_cursor.html" title="Utility class for rendering cursors.">Louvre::LCursor</a> class. Bis bald!</p>
<p><a href="11.md">◀ Chapter 11: Popups</a> || <a href="13.md">Chapter 13: Cursor ▶</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<script>
    var menu = false;
    var burger, nav;
    function resp()
    {
        if (window.innerWidth < 768)
        {
            burger.hidden = false;
            nav.hidden = true;
        }
        else
        {
            burger.hidden = true;
            nav.hidden = false;
        }
        menu = false;
    }
    function toggleMenu()
    {
        nav.hidden = menu;
        menu = !menu;
    }
    window.onload = function()
    {
        if (typeof toggleLevel !== "undefined")
            toggleLevel(2);
        // Get all <a> tags with the "el" class
        var elLinks = document.querySelectorAll('a.el');
        // Loop through the matched elements
        elLinks.forEach(function(link) 
        {
            // Replace "Louvre::" with an empty string in the text content
            link.textContent = link.textContent.replace(/Louvre::/g, '');
        });
        nav = document.getElementById('main-nav');
        burger = document.createElement('div');
        burger.style.position = 'absolute';
        burger.style.top = '14px';
        burger.style.right = burger.style.top;
        burger.innerHTML = '<svg onclick="toggleMenu()" height="32px" viewBox="0 0 448 512"><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg>';
        document.getElementById('top').appendChild(burger);
        resp();
    };
    window.onresize = function()
    {
        resp();
    };
</script>
<div id="nav-path" class="navpath">
    <ul>
        <li class="footer">Project developed by <a href="https://github.com/CuarzoSoftware"><img class="footer" src="https://avatars.githubusercontent.com/u/29326763?s=200&v=4" style="margin-left:2px;position:relative;top:-1px;width:12px;height:12px" alt="cuarzo"/> Cuarzo Software</a></li>
    </ul>
</div>