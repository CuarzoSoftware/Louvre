<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Louvre: Chapter 4: Compositor Initialization</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="Logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Louvre<span id="projectnumber">&#160;v2.18.1-1</span>
   </div>
   <div id="projectbrief">C++ library for Wayland compositors</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Chapter 4: Compositor Initialization</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In this chapter, we will explore how to customize the initialization of <a class="el" href="class_louvre_1_1_l_compositor.html" title="Louvre&#39;s core and objects factory.">Louvre::LCompositor</a>. This includes setting up parameters like the keyboard map and output arrangements. This customization will serve as a foundation for overriding the behavior of other classes in upcoming chapters.</p>
<p>To begin, let's create a new <a class="el" href="class_louvre_1_1_l_compositor.html" title="Louvre&#39;s core and objects factory.">Louvre::LCompositor</a> subclass named <code>ECompositor</code> (with the "E" prefix denoting "Example Compositor"):</p>
<h3><a class="anchor" id="srcecompositorh"></a>
src/ECompositor.h</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef ECOMPOSITOR_H</span></div>
<div class="line"><span class="preprocessor">#define ECOMPOSITOR_H</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;LCompositor.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespace_louvre.html">Louvre</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ECompositor : <span class="keyword">public</span> <a class="code hl_class" href="class_louvre_1_1_l_compositor.html">LCompositor</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    ECompositor();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> initialized() <span class="keyword">override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">// ECOMPOSITOR_H</span></div>
<div class="ttc" id="aclass_louvre_1_1_l_compositor_html"><div class="ttname"><a href="class_louvre_1_1_l_compositor.html">Louvre::LCompositor</a></div><div class="ttdoc">Louvre's core and objects factory.</div><div class="ttdef"><b>Definition</b> LCompositor.h:24</div></div>
<div class="ttc" id="anamespace_louvre_html"><div class="ttname"><a href="namespace_louvre.html">Louvre</a></div><div class="ttdoc">Namespaces.</div><div class="ttdef"><b>Definition</b> LBox.h:7</div></div>
</div><!-- fragment --><p>Here, we are overriding the <a class="el" href="class_louvre_1_1_l_compositor.html#a7916bd2f47b5b148cdb52d0f7c7803a3" title="Notifies a successful compositor initialization.">Louvre::LCompositor::initialized()</a> virtual method (click to see its default implementation).<br  />
<a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a> calls this method once the compositor has completed its initialization process after we invoke <a class="el" href="class_louvre_1_1_l_compositor.html#aad5997aaaa2d622f0ca57f8b24a51a7b" title="Starts the main event loop and backends.">Louvre::LCompositor::start()</a> in <code>src/main.cpp</code>.<br  />
This method is an ideal place to configure and load all the resources required by your compositor.</p>
<blockquote class="doxtable">
<p>&zwj;Certain objects, such as textures, can only be created within or after the invocation of <a class="el" href="class_louvre_1_1_l_compositor.html#a7916bd2f47b5b148cdb52d0f7c7803a3" title="Notifies a successful compositor initialization.">Louvre::LCompositor::initialized()</a>. This is imperative as they depend on the graphic backend to be fully initialized. </p>
</blockquote>
<h3><a class="anchor" id="srcecompositorcpp"></a>
src/ECompositor.cpp</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;LOutput.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;LSeat.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;LKeyboard.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ECompositor.h&quot;</span></div>
<div class="line"> </div>
<div class="line">ECompositor::ECompositor() {}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ECompositor::initialized()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Set a keyboard map with &quot;latam&quot; layout</span></div>
<div class="line">    seat()-&gt;<a class="code hl_function" href="class_louvre_1_1_l_seat.html#ac4ab7f9428e61a97051fce844a98cc21">keyboard</a>()-&gt;<a class="code hl_function" href="class_louvre_1_1_l_keyboard.html#af3224ac0e4648b52dbb8da1281b83549">setKeymap</a>(<span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>, <span class="stringliteral">&quot;latam&quot;</span>, <span class="keyword">nullptr</span>);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_typedef" href="namespace_louvre.html#a20b0c262d9ef5d263888e463dfa99638">Int32</a> totalWidth { 0 };</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Initialize all avaliable outputs</span></div>
<div class="line">    <span class="keywordflow">for</span> (<a class="code hl_class" href="class_louvre_1_1_l_output.html">LOutput</a> *output : <a class="code hl_function" href="namespace_louvre.html#acee23df69aa55d791385fb9813b0319a">seat</a>()-&gt;outputs())</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Set double scale to outputs with DPI &gt;= 200</span></div>
<div class="line">        output-&gt;setScale(output-&gt;dpi() &gt;= 200 ? 2.f : 1.f);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Assuming your outputs are not rotated or flipped</span></div>
<div class="line">        output-&gt;setTransform(LFramebuffer::Normal);</div>
<div class="line"> </div>
<div class="line">        output-&gt;setPos(<a class="code hl_class" href="class_louvre_1_1_l_point_template.html">LPoint</a>(totalWidth, 0));</div>
<div class="line">        totalWidth += output-&gt;size().w();</div>
<div class="line"> </div>
<div class="line">        addOutput(output);</div>
<div class="line">        output-&gt;repaint();</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="aclass_louvre_1_1_l_keyboard_html_af3224ac0e4648b52dbb8da1281b83549"><div class="ttname"><a href="class_louvre_1_1_l_keyboard.html#af3224ac0e4648b52dbb8da1281b83549">Louvre::LKeyboard::setKeymap</a></div><div class="ttdeci">bool setKeymap(const char *rules=nullptr, const char *model=nullptr, const char *layout=nullptr, const char *variant=nullptr, const char *options=nullptr) noexcept</div><div class="ttdoc">Sets the keyboard map.</div><div class="ttdef"><b>Definition</b> LKeyboard.cpp:97</div></div>
<div class="ttc" id="aclass_louvre_1_1_l_output_html"><div class="ttname"><a href="class_louvre_1_1_l_output.html">Louvre::LOutput</a></div><div class="ttdoc">A display rendering interface.</div><div class="ttdef"><b>Definition</b> LOutput.h:215</div></div>
<div class="ttc" id="aclass_louvre_1_1_l_point_template_html"><div class="ttname"><a href="class_louvre_1_1_l_point_template.html">Louvre::LPointTemplate&lt; Int32 &gt;</a></div></div>
<div class="ttc" id="aclass_louvre_1_1_l_seat_html_ac4ab7f9428e61a97051fce844a98cc21"><div class="ttname"><a href="class_louvre_1_1_l_seat.html#ac4ab7f9428e61a97051fce844a98cc21">Louvre::LSeat::keyboard</a></div><div class="ttdeci">LKeyboard * keyboard() const noexcept</div><div class="ttdoc">Access to keyboard events.</div><div class="ttdef"><b>Definition</b> LSeat.h:179</div></div>
<div class="ttc" id="anamespace_louvre_html_a20b0c262d9ef5d263888e463dfa99638"><div class="ttname"><a href="namespace_louvre.html#a20b0c262d9ef5d263888e463dfa99638">Louvre::Int32</a></div><div class="ttdeci">int32_t Int32</div><div class="ttdoc">32 bits signed integer</div><div class="ttdef"><b>Definition</b> LNamespaces.h:222</div></div>
<div class="ttc" id="anamespace_louvre_html_acee23df69aa55d791385fb9813b0319a"><div class="ttname"><a href="namespace_louvre.html#acee23df69aa55d791385fb9813b0319a">Louvre::seat</a></div><div class="ttdeci">LSeat * seat() noexcept</div><div class="ttdoc">Gets the compositor's seat.</div><div class="ttdef"><b>Definition</b> LCompositor.cpp:42</div></div>
</div><!-- fragment --><p>Here, we're first configuring the keyboard map with <a class="el" href="class_louvre_1_1_l_keyboard.html#af3224ac0e4648b52dbb8da1281b83549" title="Sets the keyboard map.">Louvre::LKeyboard::setKeymap()</a>. This keymap helps the compositor interpret raw input key codes as XKB key symbols and ensures clients can correctly understand them as well.</p>
<p>The method searches for available keymaps on your system based on the provided parameters. If no matches are found, it loads your system's default keymap. In this case, I'm using the Latin American keyboard layout since I'm Chilean. To load your system's default keymap, simply pass <code>nullptr</code> for all arguments.</p>
<p>Secondly, we iterate through all available outputs on your machine, those could be your laptop screen, HDMI connector, or others. If an output is considered High DPI (with a DPI greater than or equal to 200), we set its scale to 2 (the default is 1). This adjustment ensures that the content is properly scaled, otherwise, application windows and UI elements would appear tiny.</p>
<p>The <a class="el" href="class_louvre_1_1_l_output.html#ae4983ad9b25b32cd00f7b943894666a8" title="Sets the framebuffer transform.">Louvre::LOutput::setTransform()</a> method allows you to define a custom transform, particularly useful when dealing with physically rotated or flipped outputs. In this case, we are assigning the Louvre::LFramebuffer::Normal (no transform) as the default value.</p>
<blockquote class="doxtable">
<p>&zwj;Starting from <a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a> version 1.2, <a class="el" href="class_louvre_1_1_l_output.html#af950653f0fe07aed8acca7079047fb94" title="Sets the output scale factor.">Louvre::LOutput::setScale()</a> now supports fractional scales. For a comprehensive understanding of the output global coordinate space, fractional scaling, and transforms, refer to the <a class="el" href="class_louvre_1_1_l_output.html#Scaling">LOutput</a> documentation. </p>
</blockquote>
<p>Outputs can also be virtually positioned, as you may have done in your system's display configuration panel:</p>
<center> <img src="https://lh3.googleusercontent.com/pw/AIL4fc8mtBg1aWk8d_9hSa9_sp8V7KYVk6ZskkKgLZ6YP1ouaf-ku7zNndMoASmn2tNsD_2xW7hnHjZgaiLYfFJ-Kbv3SXZhdlGCm-sZamFHsb-Atvo0Kyg=w2400" alt="" style="max-width:45vw" class="inline"/><br  />
 <div style="margin-top:10px;font-style:italic;">Example of a system's display configuration panel.</div> </center><p>In this case, we arrange them from left to right using the <code>totalWidth</code> variable. Finally, we initialize these outputs using <a class="el" href="class_louvre_1_1_l_compositor.html#a0b328b0723a35d00bbaff5aec6b9e9e0" title="Initializes the specified output.">Louvre::LCompositor::addOutput()</a>, allowing us to render content onto them.</p>
<blockquote class="doxtable">
<p>&zwj;You can access all available outputs in your system via <a class="el" href="class_louvre_1_1_l_seat.html#a05aaba26b6841b8ea133a64d1d28cb5e" title="Vector of available outputs.">Louvre::LSeat::outputs()</a>, and for the initialized outputs only, you can use <a class="el" href="class_louvre_1_1_l_compositor.html#a05aaba26b6841b8ea133a64d1d28cb5e" title="Gets a vector of all initialized outputs.">Louvre::LCompositor::outputs()</a>.<br  />
 As the compositor and seat object instances are both static and unique, these can be accessed from any object using <code>object-&gt;compositor()</code> and <code>object-&gt;seat()</code>. </p>
</blockquote>
<p>Lastly, in <code>src/main.cpp</code>, we should replace <code>LCompositor</code> with our custom <code>ECompositor</code> class.</p>
<h3><a class="anchor" id="srcmaincpp-1"></a>
src/main.cpp</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;LLauncher.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;LLog.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ECompositor.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespace_louvre.html">Louvre</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">    setenv(<span class="stringliteral">&quot;LOUVRE_DEBUG&quot;</span>, <span class="stringliteral">&quot;4&quot;</span>, 0);</div>
<div class="line"> </div>
<div class="line">    LLauncher::startDaemon();</div>
<div class="line"> </div>
<div class="line">    ECompositor compositor;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!compositor.<a class="code hl_function" href="class_louvre_1_1_l_compositor.html#aad5997aaaa2d622f0ca57f8b24a51a7b">start</a>())</div>
<div class="line">    {</div>
<div class="line">        LLog::fatal(<span class="stringliteral">&quot;[louvre-example] Failed to start compositor.&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (compositor.<a class="code hl_function" href="class_louvre_1_1_l_compositor.html#af913e494bf1e3bf690195aba24333925">state</a>() != LCompositor::Uninitialized)</div>
<div class="line">        compositor.<a class="code hl_function" href="class_louvre_1_1_l_compositor.html#abd22d41494ee279ab64dc741689658e7">processLoop</a>(-1);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aclass_louvre_1_1_l_compositor_html_aad5997aaaa2d622f0ca57f8b24a51a7b"><div class="ttname"><a href="class_louvre_1_1_l_compositor.html#aad5997aaaa2d622f0ca57f8b24a51a7b">Louvre::LCompositor::start</a></div><div class="ttdeci">bool start()</div><div class="ttdoc">Starts the main event loop and backends.</div><div class="ttdef"><b>Definition</b> LCompositor.cpp:254</div></div>
<div class="ttc" id="aclass_louvre_1_1_l_compositor_html_abd22d41494ee279ab64dc741689658e7"><div class="ttname"><a href="class_louvre_1_1_l_compositor.html#abd22d41494ee279ab64dc741689658e7">Louvre::LCompositor::processLoop</a></div><div class="ttdeci">Int32 processLoop(Int32 msTimeout)</div><div class="ttdoc">Process the compositor's main event loop.</div><div class="ttdef"><b>Definition</b> LCompositor.cpp:312</div></div>
<div class="ttc" id="aclass_louvre_1_1_l_compositor_html_af913e494bf1e3bf690195aba24333925"><div class="ttname"><a href="class_louvre_1_1_l_compositor.html#af913e494bf1e3bf690195aba24333925">Louvre::LCompositor::state</a></div><div class="ttdeci">CompositorState state() const noexcept</div><div class="ttdoc">Gets the current compositor state.</div><div class="ttdef"><b>Definition</b> LCompositor.cpp:249</div></div>
</div><!-- fragment --><h2><a class="anchor" id="rebuilding"></a>
Rebuilding</h2>
<p>As we've added two new files, we'll need to reconfigure the project and then rebuild it with the following commands:</p>
<div class="fragment"><div class="line">$ cd project_dir</div>
<div class="line">$ meson setup build --wipe</div>
<div class="line">$ cd build</div>
<div class="line">$ meson compile</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj;Executing <code>$ meson setup build --wipe</code> is only required when you add or remove source files in your project. </p>
</blockquote>
<p>If you run the compositor again, you may not notice significant changes since <a class="el" href="class_louvre_1_1_l_compositor.html#a7916bd2f47b5b148cdb52d0f7c7803a3" title="Notifies a successful compositor initialization.">Louvre::LCompositor::initialized()</a> by default already performs similar tasks. However, if you've modified the keyboard map or the outputs transform, you should now see the desired improvements.</p>
<blockquote class="doxtable">
<p>&zwj;<a class="el" href="class_louvre_1_1_l_output.html#a33256784969e3347f423f72af1727cbd" title="Gets the output name.">Louvre::LOutput::name()</a> returns a unique and consistent name for each output, enabling you to identify them even after the system reboots. </p>
</blockquote>
<h2><a class="anchor" id="hotplugging-events"></a>
Hotplugging Events</h2>
<p>After learning how to configure outputs during startup, what happens if we connect or disconnect an output while the compositor is already running?</p>
<p><a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a> handles this automatically by initializing any newly plugged output and de-initializing it when unplugged. This functionality is managed within the <a class="el" href="class_louvre_1_1_l_seat.html" title="Group of input and output devices.">Louvre::LSeat</a> class, specifically through its <a class="el" href="class_louvre_1_1_l_seat.html#ade85a580ee6b9aa3aaead45f948d2e82" title="New available output.">Louvre::LSeat::outputPlugged()</a> and <a class="el" href="class_louvre_1_1_l_seat.html#aff161f8b1d3c715362778773b4b612c6" title="Disconnected output.">Louvre::LSeat::outputUnplugged()</a> virtual methods. While it's possible to customize these methods, it's not essential to do so at this stage of the tutorial. We will explore this further in Chapter 15: Output Hotplugging and Seat once you're comfortable working with your own subclasses.</p>
<p>In the following chapters, things are about to get more thrilling as we dive into different ways for rendering content to the outputs.</p>
<p><a href="03.md">◀ Chapter 3: Setting Up the Project</a> || <a href="05.md">Chapter 5: Rendering with LPainter ▶</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<script>
    var menu = false;
    var burger, nav;
    function resp()
    {
        if (window.innerWidth < 768)
        {
            burger.hidden = false;
            nav.hidden = true;
        }
        else
        {
            burger.hidden = true;
            nav.hidden = false;
        }
        menu = false;
    }
    function toggleMenu()
    {
        nav.hidden = menu;
        menu = !menu;
    }
    window.onload = function()
    {
        if (typeof toggleLevel !== "undefined")
            toggleLevel(2);
        // Get all <a> tags with the "el" class
        var elLinks = document.querySelectorAll('a.el');
        // Loop through the matched elements
        elLinks.forEach(function(link) 
        {
            // Replace "Louvre::" with an empty string in the text content
            link.textContent = link.textContent.replace(/Louvre::/g, '');
        });
        nav = document.getElementById('main-nav');
        burger = document.createElement('div');
        burger.style.position = 'absolute';
        burger.style.top = '14px';
        burger.style.right = burger.style.top;
        burger.innerHTML = '<svg onclick="toggleMenu()" height="32px" viewBox="0 0 448 512"><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg>';
        document.getElementById('top').appendChild(burger);
        resp();
    };
    window.onresize = function()
    {
        resp();
    };
</script>
<div id="nav-path" class="navpath">
    <ul>
        <li class="footer">Project developed by <a href="https://github.com/CuarzoSoftware"><img class="footer" src="https://avatars.githubusercontent.com/u/29326763?s=200&v=4" style="margin-left:2px;position:relative;top:-1px;width:12px;height:12px" alt="cuarzo"/> Cuarzo Software</a></li>
    </ul>
</div>