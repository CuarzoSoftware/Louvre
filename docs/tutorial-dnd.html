<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Louvre: Chapter 14: Clipboard and DND</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="Logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Louvre<span id="projectnumber">&#160;v2.18.1-1</span>
   </div>
   <div id="projectbrief">C++ library for Wayland compositors</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Chapter 14: Clipboard and DND</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Wayland protocol encompasses multiple interfaces that enable clients to exchange information through selections (clipboard) or drag &amp; drop sessions. The inner workings of these interfaces and their underlying complexities won't be extensively covered in this chapter. Instead, this chapter concentrates on practical aspects, deferring the intricate details to <a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a>, as it efficiently manages these complexities on your behalf. If you desire a more in-depth understanding of these topics, I recommend referring to the Wayland protocol documentation or exploring the Louvre::LDataDevice, Louvre::LDataSource, and Louvre::LDataOffer classes for additional insights.</p>
<h2><a class="anchor" id="data-sharing"></a>
Data Sharing</h2>
<p>When clients need to share data with other clients, they create an Louvre::LDataSource. This data source comprises a list of MIME type strings that represent the data they intend to share. This data is subsequently shared with other clients in the form of an Louvre::LDataOffer when their surfaces obtain keyboard focus or during a drag and drop session. The receiving client can then request the source client to write the data for specific MIME types into file descriptors to retrieve the information.</p>
<p>As mentioned earlier, <a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a> takes care of the data exchange process, offering you control over high-level functionality. This includes managing aspects like which clients can set the clipboard or initiate drag and drop sessions.</p>
<h2><a class="anchor" id="selections"></a>
Selections</h2>
<p>In the context of Wayland and X11, the term "Selections" essentially corresponds to the clipboard functionality. Clients can make requests to set the clipboard using Louvre::LSeat::setSelectionRequest(). Within this method, you have the authority to decide whether to grant or deny the client's request to set the clipboard. To achieve this, you simply return <code>true</code> to allow the user to set the clipboard or <code>false</code> to decline it.</p>
<p>Let's create a custom <a class="el" href="class_louvre_1_1_l_seat.html" title="Group of input and output devices.">Louvre::LSeat</a> subclass named <code>ESeat</code> to manage such request:</p>
<h3><a class="anchor" id="srceseath-2"></a>
src/ESeat.h</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef ESEAT_H</span></div>
<div class="line"><span class="preprocessor">#define ESEAT_H</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;LSeat.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespace_louvre.html">Louvre</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ESeat : <span class="keyword">public</span> <a class="code hl_class" href="class_louvre_1_1_l_seat.html">LSeat</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    ESeat(<span class="keyword">const</span> <span class="keywordtype">void</span> *params);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Set clipboard request</span></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">bool</span> setSelectionRequest(LDataDevice *device) <span class="keyword">override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">// ESEAT_H</span></div>
<div class="ttc" id="aclass_louvre_1_1_l_seat_html"><div class="ttname"><a href="class_louvre_1_1_l_seat.html">Louvre::LSeat</a></div><div class="ttdoc">Group of input and output devices.</div><div class="ttdef"><b>Definition</b> LSeat.h:26</div></div>
<div class="ttc" id="anamespace_louvre_html"><div class="ttname"><a href="namespace_louvre.html">Louvre</a></div><div class="ttdoc">Namespaces.</div><div class="ttdef"><b>Definition</b> LBox.h:7</div></div>
</div><!-- fragment --><h3><a class="anchor" id="srceseatcpp-2"></a>
src/ESeat.cpp</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;LDataDevice.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;LPointer.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;LKeyboard.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ESeat.h&quot;</span></div>
<div class="line"> </div>
<div class="line">ESeat::ESeat(<span class="keyword">const</span> <span class="keywordtype">void</span> *params) : <a class="code hl_class" href="class_louvre_1_1_l_seat.html">LSeat</a>(params) {}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> ESeat::setSelectionRequest(LDataDevice *device)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Let the client set the clipboard only if one of its surfaces has pointer or keyboard focus</span></div>
<div class="line">    <span class="keywordflow">return</span> (pointer()-&gt;focus() &amp;&amp; pointer()-&gt;focus()-&gt;client() == device-&gt;client()) ||</div>
<div class="line">           (keyboard()-&gt;focus() &amp;&amp; keyboard()-&gt;focus()-&gt;client() == device-&gt;client());</div>
<div class="line">}</div>
</div><!-- fragment --><p>In essence, we permit the client to set the clipboard only when one of its surfaces currently holds pointer or keyboard focus. Once the clipboard is set, any surface that gains keyboard focus can request to read its contents, such as when a user presses <code>Ctrl + V</code>.</p>
<p>You can also access the current data selection source with Louvre::LSeat::dataSelection() and obtain the list of supported MIME types through Louvre::LDataSource::sources().</p>
<blockquote class="doxtable">
<p>&zwj;The protocol's behavior results in the clipboard being unset when the source client is destroyed, which can lead to an inconvenient user experience since other applications can no longer request writing to their file descriptors. To address this issue, <a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a> requests the source client to write the contents into its own file descriptors. This way, even when the source client is disconnected, users can still paste the contents into other applications. <a class="el" href="namespace_louvre.html" title="Namespaces.">Louvre</a> implements this behavior for a select set of common string-based MIME types only. </p>
</blockquote>
<p>Lastly, remember to override its virtual constructor as well.</p>
<h3><a class="anchor" id="srcecompositorh-11"></a>
src/ECompositor.h</h3>
<div class="fragment"><div class="line"><span class="keyword">class </span>ECompositor : <span class="keyword">public</span> <a class="code hl_class" href="class_louvre_1_1_l_compositor.html">LCompositor</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">    <a class="code hl_class" href="class_louvre_1_1_l_seat.html">LSeat</a> *createSeatRequest(<span class="keyword">const</span> <span class="keywordtype">void</span> *params) <span class="keyword">override</span>;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">};</div>
<div class="ttc" id="aclass_louvre_1_1_l_compositor_html"><div class="ttname"><a href="class_louvre_1_1_l_compositor.html">Louvre::LCompositor</a></div><div class="ttdoc">Louvre's core and objects factory.</div><div class="ttdef"><b>Definition</b> LCompositor.h:24</div></div>
</div><!-- fragment --><h3><a class="anchor" id="srcecompositorcpp-10"></a>
src/ECompositor.cpp</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;ESeat.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="class_louvre_1_1_l_seat.html">LSeat</a> *ECompositor::createSeatRequest(<span class="keyword">const</span> <span class="keywordtype">void</span> *params)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">new</span> ESeat(params);</div>
<div class="line">}</div>
</div><!-- fragment --><p><img src="https://lh3.googleusercontent.com/pw/ADCreHdgbJtLy_zUvO4NO1osqHXHK1Ihe0whT9ELd9br8qTykn0yhxWQ7VRJYP8sD01h-o8AnvFXBj0oAQBFblnWOTycMf0KRmKK3ymDFgiAkO14GAJJ3HA=w2400" alt="" class="inline"/></p>
<h2><a class="anchor" id="drag--drop"></a>
Drag &amp; Drop</h2>
<p>Drag and drop sessions are overseen by the Louvre::LDNDManager class, which can be accessed via Louvre::LSeat::dndManager(). Clients can initiate a session by making a request through Louvre::LDNDManager::startDragRequest(). If you wish to disallow the client from starting the session, you should call Louvre::LDNDManager::cancel().</p>
<p>Throughout a session, the data source is automatically dispatched to any surface that acquires pointer focus. To inform the destination client that a drop has been performed by the user, you should call Louvre::LDNDManager::drop(), as previously demonstrated in Chapter 8: Pointer Events when the left pointer button is released.</p>
<p>Clients also have the option to create an <a class="el" href="class_louvre_1_1_l_d_n_d_icon_role.html" title="Drag &amp; drop icon role for surfaces.">Louvre::LDNDIconRole</a> for use as an icon during the session, which can be accessed through Louvre::LDNDManager::icon(). It's important to note that not all clients create an icon, so you should always check if it returns <code>nullptr</code>. We have also addressed the icon's position update in Chapter 8: Pointer Events during a pointer movement event.</p>
<p>Finally, in that chapter, we also discussed how to inform the clients about the preferred compositor action during a session, which can be to copy, move, or none for allowing the clients to decide.</p>
<p>Now, let's proceed to create our custom Louvre::LDNDManager subclass, named <code>EDNDManager</code>:</p>
<h3><a class="anchor" id="srcedndmanagerh"></a>
src/EDNDManager.h</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#ifndef EDNDMANAGER_H</span></div>
<div class="line"><span class="preprocessor">#define EDNDMANAGER_H</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;LDNDManager.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespace_louvre.html">Louvre</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>EDNDManager : <span class="keyword">public</span> LDNDManager</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    EDNDManager(<span class="keyword">const</span> <span class="keywordtype">void</span> *params);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> startDragRequest() <span class="keyword">override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">// EDNDMANAGER_H</span></div>
</div><!-- fragment --><h3><a class="anchor" id="srcedndmanagercpp"></a>
src/EDNDManager.cpp</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;LSeat.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;LPointer.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;LKeyboard.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;LDataSource.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;EDNDManager.h&quot;</span></div>
<div class="line"> </div>
<div class="line">EDNDManager::EDNDManager(<span class="keyword">const</span> <span class="keywordtype">void</span> *params) : LDNDManager(params) {}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> EDNDManager::startDragRequest()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Let the client start the session only if the origin surface has pointer focus</span></div>
<div class="line">    <span class="keywordflow">if</span> (origin()-&gt;hasPointerFocus())</div>
<div class="line">        seat()-&gt;<a class="code hl_function" href="class_louvre_1_1_l_seat.html#a7c55a27018215e867553eabc8ea4e89f">pointer</a>()-&gt;<a class="code hl_function" href="class_louvre_1_1_l_pointer.html#aae374219b7824f8d6b6b5feef601d89e">setDraggingSurface</a>(<span class="keyword">nullptr</span>);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        cancel();</div>
<div class="line">}</div>
<div class="ttc" id="aclass_louvre_1_1_l_pointer_html_aae374219b7824f8d6b6b5feef601d89e"><div class="ttname"><a href="class_louvre_1_1_l_pointer.html#aae374219b7824f8d6b6b5feef601d89e">Louvre::LPointer::setDraggingSurface</a></div><div class="ttdeci">void setDraggingSurface(LSurface *surface) noexcept</div><div class="ttdoc">Keep track of the surface pressed by the main pointer button.</div><div class="ttdef"><b>Definition</b> LPointer.cpp:372</div></div>
<div class="ttc" id="aclass_louvre_1_1_l_seat_html_a7c55a27018215e867553eabc8ea4e89f"><div class="ttname"><a href="class_louvre_1_1_l_seat.html#a7c55a27018215e867553eabc8ea4e89f">Louvre::LSeat::pointer</a></div><div class="ttdeci">LPointer * pointer() const noexcept</div><div class="ttdoc">Access to pointer events.</div><div class="ttdef"><b>Definition</b> LSeat.h:169</div></div>
</div><!-- fragment --><h3><a class="anchor" id="srcecompositorh-12"></a>
src/ECompositor.h</h3>
<div class="fragment"><div class="line"><span class="keyword">class </span>ECompositor : <span class="keyword">public</span> <a class="code hl_class" href="class_louvre_1_1_l_compositor.html">LCompositor</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">    LDNDManager *createDNDManagerRequest(<span class="keyword">const</span> <span class="keywordtype">void</span> *params) <span class="keyword">override</span>;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">};</div>
</div><!-- fragment --><h3><a class="anchor" id="srcecompositorcpp-11"></a>
src/ECompositor.cpp</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;EDNDManager.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">LDNDManager *ECompositor::createDNDManagerRequest(<span class="keyword">const</span> <span class="keywordtype">void</span> *params)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">new</span> EDNDManager(params);</div>
<div class="line">}</div>
</div><!-- fragment --><p>In this scenario, we only permit the client to initiate a drag &amp; drop session if the source surface has acquired pointer focus. The Louvre::LDNDManager::source() corresponds to the surface from which the DND operation originates.</p>
<p>You may have noticed that we are also calling <code>Louvre::LPointer::setDraggingSurface(nullptr)</code>. To refresh your memory, this auxiliary method serves to maintain pointer focus on a surface that is currently "dragged," such as when the user is selecting text. This prevents the surface from losing pointer focus if the cursor exits the surface. By setting it to <code>nullptr</code>, we ensure that the current surface does not retain pointer focus. Otherwise, during the drag &amp; drop session, no other surface would receive pointer focus, and they would be unable to receive data offers.</p>
<p><img src="https://lh3.googleusercontent.com/pw/ADCreHffCRJauTwh6Hg_oKaV2GBz87mJu-9iJFu_ZjowKiAqvbADV5dVCLIHshoVi_mXFHcDQTJdtrZvFBF2D7YiElihz2dNdDlf399nT_zdJfhdRm7cP9Y=w2400" alt="" class="inline"/></p>
<p>In the next chapter we'll delve into the handling of output hotplugging events and TTY session switching. Nos vemos!</p>
<p><a href="13.md">◀ Chapter 13: Cursor</a> || <a href="15.md">Chapter 15: Output Hotplugging and Seat ▶</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<script>
    var menu = false;
    var burger, nav;
    function resp()
    {
        if (window.innerWidth < 768)
        {
            burger.hidden = false;
            nav.hidden = true;
        }
        else
        {
            burger.hidden = true;
            nav.hidden = false;
        }
        menu = false;
    }
    function toggleMenu()
    {
        nav.hidden = menu;
        menu = !menu;
    }
    window.onload = function()
    {
        if (typeof toggleLevel !== "undefined")
            toggleLevel(2);
        // Get all <a> tags with the "el" class
        var elLinks = document.querySelectorAll('a.el');
        // Loop through the matched elements
        elLinks.forEach(function(link) 
        {
            // Replace "Louvre::" with an empty string in the text content
            link.textContent = link.textContent.replace(/Louvre::/g, '');
        });
        nav = document.getElementById('main-nav');
        burger = document.createElement('div');
        burger.style.position = 'absolute';
        burger.style.top = '14px';
        burger.style.right = burger.style.top;
        burger.innerHTML = '<svg onclick="toggleMenu()" height="32px" viewBox="0 0 448 512"><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg>';
        document.getElementById('top').appendChild(burger);
        resp();
    };
    window.onresize = function()
    {
        resp();
    };
</script>
<div id="nav-path" class="navpath">
    <ul>
        <li class="footer">Project developed by <a href="https://github.com/CuarzoSoftware"><img class="footer" src="https://avatars.githubusercontent.com/u/29326763?s=200&v=4" style="margin-left:2px;position:relative;top:-1px;width:12px;height:12px" alt="cuarzo"/> Cuarzo Software</a></li>
    </ul>
</div>